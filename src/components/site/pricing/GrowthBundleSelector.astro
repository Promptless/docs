---
import type { GrowthBundleOption } from './pricing.config';

interface Props {
  bundles: GrowthBundleOption[];
  selectedBundleId?: string;
}

const { bundles, selectedBundleId } = Astro.props;

if (!bundles.length) {
  throw new Error('GrowthBundleSelector requires at least one bundle option.');
}

const selectedBundle = bundles.find((bundle) => bundle.id === selectedBundleId) ?? bundles[0];
const selectId = 'growth-pages';
---

<div class="pl-growth-selector" data-growth-selector>
  <select
    id={selectId}
    name="growth_bundle"
    class="pl-growth-selector-select"
    data-growth-select
    aria-label="Growth article range"
  >
    {
      bundles.map((bundle) => (
        <option
          value={bundle.id}
          selected={bundle.id === selectedBundle.id}
          data-price-label={bundle.priceLabel}
        >
          {bundle.label}
        </option>
      ))
    }
  </select>
</div>

<script is:inline>
  (() => {
    const bindSelector = (container) => {
      const select = container.querySelector('[data-growth-select]');
      if (!(select instanceof HTMLSelectElement)) return;
      if (select.dataset.bound === 'true') return;
      select.dataset.bound = 'true';

      const growthCard = container.closest('[data-plan="growth"]');
      if (!(growthCard instanceof HTMLElement)) return;

      const priceNode = growthCard.querySelector('[data-growth-price]');
      if (!(priceNode instanceof HTMLElement)) return;

      const update = () => {
        const selectedOption = select.options[select.selectedIndex];
        if (!selectedOption) return;

        const priceLabel = selectedOption.dataset.priceLabel?.trim();

        if (priceLabel) {
          priceNode.textContent = priceLabel;
        }
      };

      select.addEventListener('change', update);
      update();
    };

    const init = () => {
      document.querySelectorAll('[data-growth-selector]').forEach((container) => {
        if (container instanceof HTMLElement) bindSelector(container);
      });
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init, { once: true });
    } else {
      init();
    }

    document.addEventListener('astro:page-load', init);
  })();
</script>
