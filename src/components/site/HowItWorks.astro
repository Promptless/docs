---
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';

import listenImg from '../../assets/homepage/promptless_1_listen.png';
import draftImg from '../../assets/homepage/Frame 29 (10).png';
import draftSecondaryImg from '../../assets/homepage/promptless-2-2.png';
import reviewImg from '../../assets/site/step_3.png';
import publishImg from '../../assets/homepage/Frame 35.png';

interface Step {
  id: string;
  label: string;
  description: string;
  image?: ImageMetadata;
  imageAlt?: string;
  imageSecondary?: ImageMetadata;
  imageSecondaryAlt?: string;
}

interface Props {
  steps?: Step[];
  id?: string;
  heading?: string;
  showHeading?: boolean;
  compact?: boolean;
}

const defaultSteps: Step[] = [
  {
    id: 'listen',
    label: 'Listen',
    description: 'When a PR opens, a slack thread about docs starts, or a DOC ticket gets created, Promptless automatically wakes up and decides whether it warrants a doc update',
    image: listenImg,
    imageAlt: 'Step 1: Listen - Connect to Github, Slack, and Linear',
  },
  {
    id: 'draft',
    label: 'Draft',
    description: 'Promptless does research across the context you connect it to, and proactively notifies you when there\'s a documentation suggestion.',
    image: draftImg,
    imageAlt: 'Step 2: Draft - Promptless notifies you proactively with suggestions',
    imageSecondary: draftSecondaryImg,
    imageSecondaryAlt: 'Step 2: additional Promptless draft screenshot',
  },
  {
    id: 'review',
    label: 'Review',
    description: 'Review citations, provide feedback, or edit suggestions inline.',
    image: reviewImg,
    imageAlt: 'Step 3: Review - review citations, feedback, and inline edits',
  },
  {
    id: 'publish',
    label: 'Publish',
    description: 'Open PRs or deploy directly to your docs provider.',
    image: publishImg,
    imageAlt: 'Step 4: Publish - open PRs or deploy directly to your docs provider',
  },
];

const {
  steps = defaultSteps,
  id = 'how-promptless-works',
  heading = 'How Promptless works',
  showHeading = true,
  compact = false,
} = Astro.props;
---

<section class:list={['pl-site-steps', { 'is-compact': compact }]} id={id} data-sticky-heading={showHeading ? 'true' : 'false'}>
  {showHeading && <h2 class="pl-site-steps-heading">{heading}</h2>}

  <div class="pl-site-step-list">
    {
      steps.map((step, index) => (
        <article class="pl-site-step" id={step.id}>
          <span class="pl-site-step-num">{index + 1}</span>
          <h3>{step.label}</h3>
          <p>{step.description}</p>
          {step.image ? (
            <>
              <div class="pl-site-step-surface">
                <Image src={step.image} alt={step.imageAlt ?? step.label} loading="lazy" width={616} />
              </div>
              {step.imageSecondary ? (
                <div class="pl-site-step-surface pl-site-step-surface-secondary">
                  <Image src={step.imageSecondary} alt={step.imageSecondaryAlt ?? `${step.label} additional image`} loading="lazy" width={616} />
                </div>
              ) : null}
            </>
          ) : null}
        </article>
      ))
    }
  </div>
</section>

{
  showHeading && (
    <script is:inline>
      {`(() => {
    const sections = Array.from(document.querySelectorAll('.pl-site-steps[data-sticky-heading="true"]'));
    if (!sections.length) return;

    const updateStickyState = (section) => {
      const rect = section.getBoundingClientRect();
      const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
      const visiblePx = Math.max(0, Math.min(rect.bottom, viewportHeight) - Math.max(rect.top, 0));
      const visibleRatio = visiblePx / Math.max(viewportHeight, 1);

      section.dataset.sticky = visibleRatio >= 0.5 ? 'on' : 'off';
    };

    let rafId = 0;
    const scheduleUpdate = () => {
      if (rafId) return;
      rafId = window.requestAnimationFrame(() => {
        rafId = 0;
        sections.forEach(updateStickyState);
      });
    };

    sections.forEach(updateStickyState);
    window.addEventListener('scroll', scheduleUpdate, { passive: true });
    window.addEventListener('resize', scheduleUpdate);
    document.addEventListener('astro:page-load', scheduleUpdate);
  })();`}
    </script>
  )
}
