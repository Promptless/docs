name: doc-detective

on:
  workflow_dispatch:

jobs:
  doc-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Nushell
        run: |
          curl -fsSL https://github.com/nushell/nushell/releases/latest/download/nu-linux-x86_64.tar.gz -o nu.tar.gz
          tar -xzf nu.tar.gz
          sudo mv nu-*/nu /usr/local/bin/
          rm -rf nu.tar.gz nu-*

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Write test credentials
        run: |
          cat > .doc-detective/.env <<EOF
          PROMPTLESS_TEST_EMAIL=${{ secrets.DOC_DETECTIVE_EMAIL }}
          PROMPTLESS_TEST_PASSWORD=${{ secrets.DOC_DETECTIVE_PASSWORD }}
          DATABASE_URL=${{ secrets.DANGER_WRITE_PROD_DATABASE_URL }}
          EOF

      - name: Run Doc Detective tests
        run: npx doc-detective runTests --config .doc-detective.ci.json

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: doc-detective-results
          path: .doc-detective/results/
